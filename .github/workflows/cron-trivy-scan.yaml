name: Trivy Ï†ïÍ∏∞ Í≤ÄÏÇ¨

on:
  schedule:
    - cron: "*/2 * * * *" # Îß§ 2Î∂ÑÎßàÎã§ Ïã§Ìñâ
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

env:
  IMAGE_NAME: public.ecr.aws/ddocdoc-public-registry/ddocdoc-hoppscotch
  IMAGE_TAG: latest

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read          # Required to checkout and read repo files
      security-events: write  # Required to upload SARIF files to Security tab
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull latest image
        run: |
          docker pull ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Check vulnerabilities and fail if found
        id: check_vulns
        run: |
          VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json)
          
          if [ "$VULN_COUNT" -gt 0 ]; then
            CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
            HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)

            echo "has_vulns=true" >> $GITHUB_OUTPUT
            echo "::error title=Ï∑®ÏïΩÏ†ê Î∞úÍ≤¨::$VULN_COUNTÍ∞úÏùò Î≥¥Ïïà Ï∑®ÏïΩÏ†êÏù¥ Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§ (CRITICAL: $CRITICAL_COUNT, HIGH: $HIGH_COUNT)"
            echo "‚ùå Î≥¥Ïïà Ï∑®ÏïΩÏ†ê Î∞úÍ≤¨"
            echo "   - CRITICAL: $CRITICAL_COUNTÍ∞ú"
            echo "   - HIGH: $HIGH_COUNTÍ∞ú"
            echo ""
            echo "Security ÌÉ≠ÏóêÏÑú ÏÉÅÏÑ∏ Í≤∞Í≥º Î≥¥Í∏∞ : https://github.com/${{ github.repository }}/security/code-scanning?query=is%3Aopen+branch%3A${{ github.ref_name }}"
            exit 1
          else
            echo "has_vulns=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Ï∑®ÏïΩÏ†êÏù¥ Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
          fi

      - name: Run Trivy for SARIF output
        if: always() && steps.check_vulns.outputs.has_vulns == 'true'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Generate vulnerability summary
        if: always()
        run: |
          if [ -f trivy-results.json ]; then
            echo "## üîç Trivy Î≥¥Ïïà Ï∑®ÏïΩÏ†ê Ïä§Ï∫î Í≤∞Í≥º" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Ïù¥ÎØ∏ÏßÄ**: \`${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json)
            
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "‚ö†Ô∏è **$VULN_COUNTÍ∞ú**Ïùò Ï∑®ÏïΩÏ†ê Î∞úÍ≤¨ (CRITICAL, HIGH)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Ïã¨Í∞ÅÎèÑ | CVE ID | Ìå®ÌÇ§ÏßÄ | ÏÑ§ÏπòÎêú Î≤ÑÏ†Ñ | ÏàòÏ†ï Î≤ÑÏ†Ñ | Ï†úÎ™© |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|--------|--------|-------------|-----------|------|" >> $GITHUB_STEP_SUMMARY
              
              jq -r '.Results[]?.Vulnerabilities[]? | [.Severity, .VulnerabilityID, .PkgName, .InstalledVersion, (.FixedVersion // "N/A"), .Title] | @tsv' trivy-results.json | \
              while IFS=$'\t' read -r severity cve pkg installed fixed title; do
                cve_lower=$(echo "$cve" | tr '[:upper:]' '[:lower:]')
                echo "| $severity | [$cve](https://avd.aquasec.com/nvd/$cve_lower) | $pkg | $installed | $fixed | $title |" >> $GITHUB_STEP_SUMMARY
              done
              
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ Ï∑®ÏïΩÏ†êÏù¥ Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§ (CRITICAL, HIGH)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.check_vulns.outputs.has_vulns == 'true'
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Send Slack notification
        if: always() && steps.check_vulns.outputs.has_vulns == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json)
          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          
          # ÏÉÅÏúÑ 5Í∞ú Ï∑®ÏïΩÏ†ê Ï∂îÏ∂ú
          TOP_VULNS=$(jq -r '.Results[]?.Vulnerabilities[]? | "\(.Severity): \(.VulnerabilityID) - \(.PkgName)"' trivy-results.json | head -5 | sed 's/^/‚Ä¢ /')
          
          PAYLOAD=$(cat <<EOF
          {
            "text": "üö® *Trivy Ï∑®ÏïΩÏ†ê Î∞úÍ≤¨*",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üö® Trivy Î≥¥Ïïà Ï∑®ÏïΩÏ†ê Í≤ÄÏÇ¨ Í≤∞Í≥º"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Ïù¥ÎØ∏ÏßÄ:*\n\`${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Ï¥ù Ï∑®ÏïΩÏ†ê:*\n$VULN_COUNTÍ∞ú"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*CRITICAL:*\n$CRITICAL_COUNTÍ∞ú"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*HIGH:*\n$HIGH_COUNTÍ∞ú"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Ï£ºÏöî Ï∑®ÏïΩÏ†ê:*\n$TOP_VULNS"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<https://github.com/${{ github.repository }}/security/code-scanning?query=is%3Aopen+branch%3A${{ github.ref_name }}|Security ÌÉ≠ÏóêÏÑú Ï†ÑÏ≤¥ Í≤∞Í≥º Î≥¥Í∏∞>"
                }
              }
            ]
          }
          EOF
          )
          
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD" 
