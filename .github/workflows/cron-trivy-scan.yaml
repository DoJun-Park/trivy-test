name: Trivy ì •ê¸° ê²€ì‚¬

on:
  schedule:
    - cron: "0 21 * * *" # ë§¤ì¼ KST ê¸°ì¤€, ìƒˆë²½ 6ì‹œ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  IMAGE_NAME: public.ecr.aws/ddocdoc-public-registry/ddocdoc-hoppscotch
  IMAGE_TAG: latest

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read          # Required to checkout and read repo files
      security-events: write  # Required to upload SARIF files to Security tab
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull latest image
        run: |
          docker pull ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Check vulnerabilities and fail if found
        id: check_vulns
        run: |
          VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json)
          
          if [ "$VULN_COUNT" -gt 0 ]; then
            CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
            HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)

            echo "has_vulns=true" >> $GITHUB_OUTPUT
            echo "::error title=ì·¨ì•½ì  ë°œê²¬::$VULN_COUNTê°œì˜ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤ (CRITICAL: $CRITICAL_COUNT, HIGH: $HIGH_COUNT)"
            echo "âŒ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬"
            echo "   - CRITICAL: $CRITICAL_COUNTê°œ"
            echo "   - HIGH: $HIGH_COUNTê°œ"
            echo ""
            echo "Security íƒ­ì—ì„œ ìƒì„¸ ê²°ê³¼ ë³´ê¸° : https://github.com/${{ github.repository }}/security/code-scanning?query=is%3Aopen+branch%3A${{ github.ref_name }}"
            exit 1
          else
            echo "has_vulns=false" >> $GITHUB_OUTPUT
            echo "âœ… ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          fi

      - name: Run Trivy for SARIF output
        if: always() && steps.check_vulns.outputs.has_vulns == 'true'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Generate vulnerability summary
        if: always()
        run: |
          if [ -f trivy-results.json ]; then
            echo "## ðŸ” Trivy ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº” ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ì´ë¯¸ì§€**: \`${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json)
            
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "âš ï¸ **$VULN_COUNTê°œ**ì˜ ì·¨ì•½ì  ë°œê²¬ (CRITICAL, HIGH)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| ì‹¬ê°ë„ | CVE ID | íŒ¨í‚¤ì§€ | ì„¤ì¹˜ëœ ë²„ì „ | ìˆ˜ì • ë²„ì „ | ì œëª© |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|--------|--------|-------------|-----------|------|" >> $GITHUB_STEP_SUMMARY
              
              jq -r '.Results[]?.Vulnerabilities[]? | [.Severity, .VulnerabilityID, .PkgName, .InstalledVersion, (.FixedVersion // "N/A"), .Title] | @tsv' trivy-results.json | \
              while IFS=$'\t' read -r severity cve pkg installed fixed title; do
                cve_lower=$(echo "$cve" | tr '[:upper:]' '[:lower:]')
                echo "| $severity | [$cve](https://avd.aquasec.com/nvd/$cve_lower) | $pkg | $installed | $fixed | $title |" >> $GITHUB_STEP_SUMMARY
              done
              
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ (CRITICAL, HIGH)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.check_vulns.outputs.has_vulns == 'true'
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Send Slack notification
        if: always() && steps.check_vulns.outputs.has_vulns == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json)
          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          
          PAYLOAD=$(cat <<EOF
          {
            "text": "ðŸš¨ *Trivy ì·¨ì•½ì  ë°œê²¬*",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ðŸš¨ Trivy ì´ë¯¸ì§€ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ê²°ê³¼"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "â€¢ *Repository:* ${{ github.repository }}\n\nâ€¢ *ì·¨ì•½ì  ë°œê²¬ ì´ë¯¸ì§€:* \`${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}\`\n\nâ€¢ *ì´ ì·¨ì•½ì :* $VULN_COUNTê°œ (CRITICAL: $CRITICAL_COUNT, HIGH: $HIGH_COUNT)"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<https://github.com/${{ github.repository }}/security/code-scanning|ðŸ”— Security íƒ­ì—ì„œ ì „ì²´ ê²°ê³¼ ë³´ê¸°>"
                }
              }
            ]
          }
          EOF
          )
          
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD" 
