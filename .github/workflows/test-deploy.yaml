name: ÏÑ§Ï†ï_Í∞úÎ∞úÌôòÍ≤Ω Î∞∞Ìè¨
on:
  workflow_dispatch:
  push:
    branches:
      - test-server
  pull_request:
    branches:
      - test-server

env:
  EKS_VERSION: 1.32
  SERVICE_NAME: trivy-test
  DEPLOY_ENV: test
  BUILD_SERVICE_NAME: trivy-test
  NODE_VERSION: node-22
  DOCKER_PATH: ./Dockerfile


jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read          # Required to checkout and read repo files
      security-events: write  # Required to upload SARIF files to Security tab
      pull-requests: write    # Required to comment on pull requests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js env
        run: |
          echo "NODE_HOME=/opt/${{ env.NODE_VERSION }}" >> $GITHUB_ENV
          echo "PATH=$PATH:/opt/${{ env.NODE_VERSION }}/bin" >> $GITHUB_ENV

      - name: Check Node version
        run: node --version

      - name: Set Short SHA
        id: slug
        run: echo "sha8=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT
      
      - name: Set Image Tag
        env:
          IMAGE_TAG: ${{ steps.slug.outputs.sha8 }}
        run: |
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Build Docker Image
        run: |
          docker build \
            -f ${{ env.DOCKER_PATH }} \
            -t trivy-test:${{ env.image_tag }} \
            -t trivy-test:latest \
            .
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: trivy-test:${{ env.image_tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Print Security tab link
        if: always()
        run: |
          echo "::notice title=Security Scan Results::View results at https://github.com/${{ github.repository }}/security/code-scanning?query=is%3Aopen+branch%3Atest-server+" # test-server Î∏åÎûúÏπòÏóê ÎåÄÌïú Ï∑®ÏïΩÏ†ê Ïä§Ï∫î Í≤∞Í≥º ÎßÅÌÅ¨

      - name: Check and report vulnerabilities
        if: always()
        run: |
          if [ -f trivy-results.sarif ]; then
            VULN_COUNT=$(jq '.runs[0].results | length' trivy-results.sarif)
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "::warning title=Security Vulnerabilities Found::Found $VULN_COUNT vulnerabilities (CRITICAL, HIGH)"
              echo "üîç Trivy Security Scan Results"
              echo "‚ö†Ô∏è Found $VULN_COUNT vulnerabilities (CRITICAL, HIGH)"
              echo "View detailed results at: https://github.com/${{ github.repository }}/security/code-scanning"
            else
              echo "‚úÖ No vulnerabilities found"
            fi
          fi

      - name: Comment PR with Trivy results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const sarifData = JSON.parse(fs.readFileSync('trivy-results.sarif', 'utf8'));
            const results = sarifData.runs[0].results || [];
            
            if (results.length > 0) {
              let comment = '## üîç Trivy Security Scan Results\n\n';
              comment += `‚ö†Ô∏è Found **${results.length}** vulnerabilities (CRITICAL, HIGH)\n\n`;
              comment += `[View detailed results in Security tab](https://github.com/${{ github.repository }}/security/code-scanning)\n`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              let comment = '## ‚úÖ Trivy Security Scan Results\n\n';
              comment += 'No vulnerabilities found (CRITICAL, HIGH)\n';
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }  