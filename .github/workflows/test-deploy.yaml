name: ì„¤ì •_ê°œë°œí™˜ê²½ ë°°í¬
on:
  workflow_dispatch:
  push:
    branches:
      - test-server
  pull_request:
    branches:
      - test-server

env:
  EKS_VERSION: 1.32
  SERVICE_NAME: trivy-test
  DEPLOY_ENV: test
  BUILD_SERVICE_NAME: trivy-test
  NODE_VERSION: node-22
  DOCKER_PATH: ./Dockerfile


jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read          # Required to checkout and read repo files
      security-events: write  # Required to upload SARIF files to Security tab
      pull-requests: write    # Required to comment on pull requests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js env
        run: |
          echo "NODE_HOME=/opt/${{ env.NODE_VERSION }}" >> $GITHUB_ENV
          echo "PATH=$PATH:/opt/${{ env.NODE_VERSION }}/bin" >> $GITHUB_ENV

      - name: Check Node version
        run: node --version

      - name: Set Short SHA
        id: slug
        run: echo "sha8=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT
      
      - name: Set Image Tag
        env:
          IMAGE_TAG: ${{ steps.slug.outputs.sha8 }}
        run: |
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Build Docker Image
        run: |
          docker build \
            -f ${{ env.DOCKER_PATH }} \
            -t trivy-test:${{ env.image_tag }} \
            -t trivy-test:latest \
            .
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: trivy-test:${{ env.image_tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Run Trivy for JSON output
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: trivy-test:${{ env.image_tag }}
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Generate vulnerability summary
        if: always()
        run: |
          if [ -f trivy-results.json ]; then
            echo "## ğŸ” Trivy Security Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json)
            
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "âš ï¸ Found **$VULN_COUNT** vulnerabilities (CRITICAL, HIGH)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Severity | Package | Installed | Fixed | Status | Title |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|---------|-----------|-------|--------|-------|" >> $GITHUB_STEP_SUMMARY
              
              jq -r '.Results[]?.Vulnerabilities[]? | [.Severity, .PkgName, .InstalledVersion, (.FixedVersion // "N/A"), (.Status // "unknown"), .Title] | @tsv' trivy-results.json | \
              while IFS=$'\t' read -r severity pkg installed fixed status title; do
                echo "| $severity | $pkg | $installed | $fixed | $status | $title |" >> $GITHUB_STEP_SUMMARY
              done
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "[View detailed results in Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No vulnerabilities found (CRITICAL, HIGH)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Print Security tab link
        if: always()
        run: |
          echo "::notice title=Security Scan Results::View results at https://github.com/${{ github.repository }}/security/code-scanning/security/code-scanning?query=is%3Aopen+branch%3Atest-server+""

      - name: Check and report vulnerabilities
        if: always()
        run: |
          if [ -f trivy-results.sarif ]; then
            VULN_COUNT=$(jq '.runs[0].results | length' trivy-results.sarif)
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "::warning title=Security Vulnerabilities Found::Found $VULN_COUNT vulnerabilities (CRITICAL, HIGH)"
              echo "ğŸ” Trivy Security Scan Results"
              echo "âš ï¸ Found $VULN_COUNT vulnerabilities (CRITICAL, HIGH)"
              echo "View detailed results at: https://github.com/${{ github.repository }}/security/code-scanning?query=is%3Aopen+branch%3Atest-server+"  # test-server ë¸Œëœì¹˜ì— ëŒ€í•œ ì·¨ì•½ì  ìŠ¤ìº” ê²°ê³¼ ë§í¬
            else
              echo "âœ… No vulnerabilities found"
            fi
          fi